<!DOCTYPE html>
<html lang="pt-BR">

<head>
	<title>Colabore - RevitaSP</title>
	<link rel="stylesheet" href="./src/assets/css/global.css">
	<link rel="stylesheet" href="./src/assets/css/header.css">
	<link rel="stylesheet" href="./src/assets/css/projetos.css">
	<link rel="stylesheet" href="./src/assets/css/colabore.css">
	<meta charset="UTF-8">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>

<body>
	<header class="header-container">
		<nav class="navbar">
			<ul class="nav-list">
				<li><a href="index.html#inicio" class="nav-item-link">In√≠cio</a></li>
				<li><a href="index.html#projeto" class="nav-item-link">O Projeto</a></li>
				<li><a href="index.html#projetos" class="nav-item-link">Pr√©dios Hist√≥ricos</a></li>
				<li><a href="index.html#retrofit" class="nav-item-link">Retrofit SP</a></li>
				<li><a href="index.html#sobre" class="nav-item-link">Sobre N√≥s</a></li>
				<li><a href="./colabore.html" class="nav-item-link">Colabore</a></li>
				<li><a href="./colaboracoes.html" class="nav-item-link">Colabora√ß√µes</a></li>
			</ul>
		</nav>
		<button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">üåô</button>
		<button class="theme-toggle-mobile" id="themeToggle" aria-label="Toggle dark mode">üåô</button>
		<button class="hamburger" id="hamburgerMenu" aria-label="Abrir menu">‚ò∞</button>
		<nav class="mobile-menu" id="mobileMenu">
			<ul class="nav-list">
				<li><a href="index.html#inicio" class="nav-item-link">In√≠cio</a></li>
				<li><a href="index.html#projeto" class="nav-item-link">O Projeto</a></li>
				<li><a href="index.html#projetos" class="nav-item-link">Pr√©dios Hist√≥ricos</a></li>
				<li><a href="index.html#retrofit" class="nav-item-link">Retrofit SP</a></li>
				<li><a href="index.html#sobre" class="nav-item-link">Sobre N√≥s</a></li>
				<li><a href="./colabore.html" class="nav-item-link">Colabore</a></li>
				<li><a href="./colaboracoes.html" class="nav-item-link">Colabora√ß√µes</a></li>
			</ul>
		</nav>
	</header>

	<div class="form-container">
		<h1>Colabore com o RevitaSP</h1>
		<p style="margin-bottom: 30px; font-size: 18px;">
			Compartilhe suas sugest√µes e contribua para a revitaliza√ß√£o do centro hist√≥rico de S√£o Paulo.
		</p>

		<form id="colaboracaoForm">
			<div class="form-group">
				<label for="nome">Nome:</label>
				<input type="text" id="nome" name="nome" required placeholder="Digite seu nome">
			</div>

			<div class="form-group">
				<label for="sugestao">Sua Sugest√£o:</label>
				<textarea id="sugestao" name="sugestao" required
					placeholder="Descreva sua sugest√£o de melhoria ou manuten√ß√£o para o centro hist√≥rico..."></textarea>
			</div>

			<div class="form-group">
				<label>Imagem (opcional):</label>
				<div class="file-upload">
					<input type="file" id="imagem" name="imagem" accept="image/*" onchange="previewImage(event)">
					<label for="imagem">Escolher arquivo</label>
				</div>
				<div class="image-preview" id="imagePreview">
					<img id="preview" src="#" alt="Preview da imagem">
				</div>
			</div>

			<div style="display: flex; justify-content: center;">
				<button type="submit" class="submit-button">Enviar Sugest√£o</button>
			</div>
		</form>
	</div>

	<script src="./src/assets/scripts/index.js"></script>

	<script>
		function previewImage(event) {
			var preview = document.getElementById('preview');
			var previewContainer = document.getElementById('imagePreview');
			var file = event.target.files[0];
			var reader = new FileReader();

			reader.onload = function () {
				preview.src = reader.result;
				previewContainer.style.display = 'block';
			}

			if (file) {
				reader.readAsDataURL(file);
			}
		}

		var themeToggle = document.getElementById('themeToggle');
		var prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

		var currentTheme = localStorage.getItem('theme') ||
			(prefersDarkScheme.matches ? 'dark' : 'light');

		document.documentElement.setAttribute('data-theme', currentTheme);
		updateThemeIcon(currentTheme);

		themeToggle.addEventListener('click', () => {
			var newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
			document.documentElement.setAttribute('data-theme', newTheme);
			localStorage.setItem('theme', newTheme);
			updateThemeIcon(newTheme);
		});

		function updateThemeIcon(theme) {
			themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
		}

		async function criarColaboracao(nome, sugestao, imagem) {
			console.log("üöÄ ~ criarColaboracao ~ imagem:", imagem)
			console.log("üöÄ ~ criarColaboracao ~ imagem:", imagem.type)
			console.log("üöÄ ~ criarColaboracao ~ sugestao:", sugestao)
			console.log("üöÄ ~ criarColaboracao ~ nome:", nome)
			var url = 'https://rfzdciezrbgkhpcfacet.supabase.co';
			var apiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmemRjaWV6cmJna2hwY2ZhY2V0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMTU0OTksImV4cCI6MjA2NTY5MTQ5OX0.dZwWjmraUNYYw7eYjKPuf3_9qmtpPi5_I1rWh2ld9-c';
			var storageName = 'images';
			var imagemCriadaUrl;

			if (imagem) {
				var fileName = `${Date.now()}_${imagem.name}`;
				var uploadUrl = `${url}/storage/v1/object/${storageName}/public/${fileName}`;

				try {
					var uploadRequisicao = await fetch(uploadUrl, {
						method: 'POST',  // <<< ALTERADO AQUI
						headers: {
							'apikey': apiKey,
							'Authorization': `Bearer ${apiKey}`,
							'Content-Type': imagem.type,
							'Content-Length': imagem.size,
							'x-upsert': true
						},
						body: imagem
					});

					if (!uploadRequisicao.ok) {
						console.error(await uploadRequisicao.json());
						alert('Erro ao fazer upload da imagem!');
						return;
					}

					imagemCriadaUrl = `${url}/storage/v1/object/${storageName}/public/${fileName}`;
					console.log('Imagem salva em:', imagemCriadaUrl);
					alert('Deu certo!')
				} catch (error) {
					console.error('Upload error:', error);
					throw new Error('Falha no upload da imagem.');
				}
			}

			try {
				var requisicao = await fetch(
					`${url}/rest/v1/colaboracoes`, {
					method: 'POST',
					headers: {
						'apikey': apiKey,
						'Authorization': `Bearer ${apiKey}`,
						'Content-Type': 'application/json',
						'Prefer': 'return=representation'
					},
					body: JSON.stringify({ nome, sugestao, imagem_url: imagemCriadaUrl })
				});

				var data = await requisicao.json();

				if (!requisicao.ok) {
					console.error('Erro ao salvar no banco:', data);
					throw new Error('Erro ao salvar a mensagem.');
				}

				return data;
			} catch (error) {
				console.log("üöÄ ~ criarColaboracao ~ error:", error)
				throw new Error('Erro ao salvar a mensagem.');
			}
		}

		var form = document.getElementById('colaboracaoForm');

		form.addEventListener('submit', async function (event) {
			event.preventDefault();
			var nome = document.getElementById('nome').value;
			var sugestao = document.getElementById('sugestao').value;
			var imagem = document.getElementById('imagem').files[0];

			await criarColaboracao(nome, sugestao, imagem);
			alert('Sua sugest√£o foi enviada com sucesso!');
			form.reset();
			document.getElementById('imagePreview').style.display = 'none';


		});

	</script>
</body>

</html>